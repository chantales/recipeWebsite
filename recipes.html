<!DOCTYPE html>
<html lang="en">
<head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Recipes</title>
      <link rel="stylesheet" href="styles.css"/>
</head>
<body>
<div id="searchContainer">
      <input type="text" id="searchInputBar" placeholder="Search recipes by title..." />
      
      <div class="searchContDropD">

            <button type="button" id="mealFilterBtn">Meals</button>
                  <div id="mealDropD" class="filterDropDContent">
                        <button type="button" class="dropDBtn" data-tag="breakfast">Breakfast</button>
                        <button type="button" class="dropDBtn" data-tag="lunch">Lunch</button>
                        <button type="button" class="dropDBtn" data-tag="dinner">Dinner</button>
                        <button type="button" class="dropDBtn" data-tag="dessert">Dessert</button>
                        <button type="button" class="dropDBtn" data-tag="snack">Snack</button>
                        <button type="button" class="dropDBtn" data-tag="other">Other</button>
                  </div>

            <button type="button" id="dietFilterBtn">Dietary Specifications</button>
                  <div id="dietDropD" class="filterDropDContent">
                        <button type="button" class="dropDBtn" data-tag="vegetarian">Vegetarian</button>
                        <button type="button" class="dropDBtn" data-tag="vegan">Vegan</button>
                        <button type="button" class="dropDBtn" data-tag="gluten-free">Gluten-free</button>
                        <button type="button" class="dropDBtn" data-tag="halal">Halal</button>
                        <button type="button" class="dropDBtn" data-tag="kosher">Kosher</button>
                        <button type="button" class="dropDBtn" data-tag="other">Other</button>
                        <button type="button" class="dropDBtn" data-tag="none">None</button>
                  </div>      
      </div>
</div>


<h1>Add a New Recipe</h1>
<br>
<br>

<form id="recipeForm">
      <label>
      Title:
      <input type="text" id="titleOfRecipe" required />
      </label>

      <label>
            Meal of the day
            <button type="button" class="tagBtn" data-tag="breakfast">Breakfast</button>
            <button type="button" class="tagBtn" data-tag="lunch">Lunch</button>
            <button type="button" class="tagBtn" data-tag="dinner">Dinner</button>
            <button type="button" class="tagBtn" data-tag="dessert">Dessert</button>
            <button type="button" class="tagBtn" data-tag="snack">Snack</button>
            <button type="button" class="tagBtn" data-tag="other">Other</button>
      </label>    

      <label>
            Dietary specifcations
            <button type="button" class="dietSpefBtn" data-tag="vegetarian">Vegetarian</button>
            <button type="button" class="dietSpefBtn" data-tag="vegan">Vegan</button>
            <button type="button" class="dietSpefBtn" data-tag="gluten-free">Gluten-free</button>
            <button type="button" class="dietSpefBtn" data-tag="halal">Halal</button>
            <button type="button" class="dietSpefBtn" data-tag="kosher">Kosher</button>
            <button type="button" class="dietSpefBtn" data-tag="other">Other</button>
            <button type="button" class="dietSpefBtn" data-tag="none">None</button>
      </label> 

      Prep Time:
      <input type="number" id="prepTimeOfRecipe"/>
      </label>

      <label>
      Cooking Time:
      <input type="number" id="cookingTimeOfRecipe"/>
      </label>

      <label>
      Ingredients (working on it)
      <textarea id="ingredientsOfRecipe"></textarea>
      </label>

      <label>
      Instructions:
      <div id="instructionsContainer"></div>
      <button type="button" id="addStepBtn">Add Step</button>
      </label>

      <button type="button" id="saveRecipeBtn">Save recipe</button>

      <br>
      <br>
      <h1>All recipes </h1>
      <div id="pullAllRecipes"></div>

</form>



<script type="module">
      // Import the functions you need from the SDKs you need
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
// TODO: Add SDKs for Firebase products that you want to use
// https://firebase.google.com/docs/web/setup#available-libraries

// Your web app's Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyDaFwUkn50NhSRt3FgS68lidSap4NqyPxk",
  authDomain: "listofrecipes-d88b8.firebaseapp.com",
  databaseURL: "https://listofrecipes-d88b8-default-rtdb.firebaseio.com",
  projectId: "listofrecipes-d88b8",
  storageBucket: "listofrecipes-d88b8.firebasestorage.app",
  messagingSenderId: "147673777707",
  appId: "1:147673777707:web:9c9a187722377fec470c6e"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
import {getDatabase, set, ref, push, get, update, remove, child, onChildAdded}
from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

const database = getDatabase();


console.log("code updated 1");

const form = document.getElementById("recipeForm");
const instructionsContainer = document.getElementById("instructionsContainer");
const addStepBtn = document.getElementById("addStepBtn");
const saveRecipeBtn = document.getElementById("saveRecipeBtn");
const pullAllRecipes = document.getElementById("pullAllRecipes");
const recipesRef = ref(database, "recipes");


let allRecipesList = [];
let tags = [];
let dietarySpef = [];
let stepCount = 0;





function renderFilteredRecipes(query) {
  pullAllRecipes.innerHTML = "";
  
      const filtered = allRecipesList.filter(([id, recipe]) => {
            const matchesTitle = recipe.title.toLowerCase().includes(query.toLowerCase());

            const matchesTags = tags.length === 0 || tags.every(tag => recipe.tags?.includes(tag));
            const matchesDiet = dietarySpef.length === 0 || dietarySpef.every(diet => recipe.dietarySpef?.includes(diet));

      return matchesTitle && matchesTags && matchesDiet;
  });

      filtered.forEach(([id, recipe]) => {
            const recipeDiv = displayRecipe(recipe, id);
      pullAllRecipes.appendChild(recipeDiv);
  });
};

document.getElementById("mealFilterBtn").addEventListener("click", () => {
  document.getElementById("mealDropD").classList.toggle("show");
});

document.getElementById("dietFilterBtn").addEventListener("click", () => {
  document.getElementById("dietDropD").classList.toggle("show");
});


window.onclick = function(event) {
  if (!event.target.matches('#mealFilterBtn') && !event.target.matches('#dietSpefFilterBtn')) {
    document.querySelectorAll(".filterDropDContent").forEach(dropdown => {
      dropdown.classList.remove("show");
    });
  }
};






document.querySelectorAll(".tagBtn").forEach(btn => {
  btn.addEventListener("click", () => {
    const tag = btn.dataset.tag;
    addTag(tag);
  });
});

document.querySelectorAll(".dietSpefBtn").forEach(btn => {
  btn.addEventListener("click", () => {
    const dietSpef = btn.dataset.tag;
    addDietSpef(dietSpef);
  });
});


document.querySelectorAll(".dropDBtn").forEach(btn => {
  btn.addEventListener("click", () => {
    const tag = btn.dataset.tag;

    if (tags.includes(tag)) {
      tags = tags.filter(t => t !== tag);
    } else {
      tags.push(tag);
    }

    console.log("Dropdown tag selected:", tags);

    const query = document.getElementById("searchInputBar").value;
    renderFilteredRecipes(query);
  });
});












addStep();
addStepBtn.addEventListener("click", () => addStep());

function addTag(tag) {
      if (tags.includes(tag)) {
            tags = tags.filter(t => t !==tag);
      } else {
            tags.push(tag);
      }
      console.log("tags selected:", tags);
};

function addDietSpef(dietSpef) {
      if (dietarySpef.includes(dietSpef)) {
            dietarySpef = dietarySpef.filter(t => t !==dietSpef);
      } else {
            dietarySpef.push(dietSpef);
      }
      console.log("Dietary Specifications selected:", dietarySpef);
};



function addStep(initialValue = "") {
      stepCount++;
      console.log("step function was activated");

      const stepDiv = document.createElement("div");
      stepDiv.classList.add("stepContainer");

      const stepLabel = document.createElement("div");
      stepLabel.classList.add("stepNumber");
      stepLabel.textContent = `Step ${stepCount}:`;

      const stepInput = document.createElement("input");
      stepInput.type = "text";
      stepInput.value = initialValue;

      const removeBtn = document.createElement("button");
      removeBtn.type = "button";
      removeBtn.textContent = "X";
      removeBtn.classList.add("removeBtn")

      removeBtn.addEventListener("click", () => {
            instructionsContainer.removeChild(stepDiv);
            updateStepNumbers();
      });

      stepDiv.appendChild(stepLabel);
      stepDiv.appendChild(stepInput);
      stepDiv.appendChild(removeBtn);
      instructionsContainer.appendChild(stepDiv);
      }

      function updateStepNumbers() {
            stepCount = 0;
            instructionsContainer.querySelectorAll(".stepContainer").forEach((div) => {
                  stepCount++;
                  const stepLabel = div.querySelector(".stepNumber");
                  if (stepLabel) {
            stepLabel.textContent = `Step ${stepCount}:`;
                  }
            });
      }






saveRecipeBtn.addEventListener("click", (e) => {
e.preventDefault();

      const title = document.getElementById("titleOfRecipe").value.trim();
      const prepTime = document.getElementById("prepTimeOfRecipe").value;
      const cookingTime = document.getElementById("cookingTimeOfRecipe").value;
      const ingredientsString = document.getElementById("ingredientsOfRecipe").value.trim();

      const ingredients = ingredientsString
            ? ingredientsString.split("\n").map(line => line.trim()).filter(line => line !== "")
            : [];


      const instructionInputs = instructionsContainer.querySelectorAll("input");
      const instructions = Array.from(instructionInputs)
            .map(input => input.value.trim())
            .filter(line => line !== "");

      const recipe = {
            title,
            tags,
            dietarySpef,
            prepTime,
            cookingTime,
            ingredients,
            instructions
      };

      const newRecipeRef = push(recipesRef);
      const recipeID = newRecipeRef.key;

      set(newRecipeRef, recipe) 
            .then(() => { // after saving the recipe, the elements in the page are cleared and reset. 
            alert("Recipe saved successfully!");
            form.reset();
            instructionsContainer.innerHTML = "";
            stepCount = 0;
            addStep(); 
      })
            .catch((error) => {
            console.error("Error saving recipe:", error);
            alert("something went wrong :(");
      });
});


/* onChildAdded(recipesRef, (snapshot) => {
const recipe = snapshot.val();
displayRecipe(recipe);
}); */

get(recipesRef)
.then((snapshot) => {
      if (snapshot.exists()) {
            const recipes = snapshot.val();
            pullAllRecipes.innerHTML = "";
            allRecipesList = Object.entries(recipes); // store as [id, recipe] pairs

            renderFilteredRecipes(""); // show all recipes on page load
      } else {
            pullAllRecipes.innerHTML = "<p>No recipes found.</p>";
    }
})
.catch((error) => {
      console.error("Error loading recipes:", error);
});



function displayRecipe(recipe, ID) {
      const recipeDiv = document.createElement("div");
      recipeDiv.classList.add("recipeCard");
      

recipeDiv.innerHTML = `
      <h3> <a href="recipe.html?id=${ID}" target="_blank">${recipe.title}</a></h3>
      <p> <strong>Tags:</strong> ${recipe.tags?.join(", ") || "None"}</p>
      <p> <strong>Dietary Specifications:</strong> ${recipe.dietarySpef?.join(", ") || "None"}</p>
      <p> <strong>Preparing Time:</strong> ${recipe.prepTime || "?"} mins</p>
      <p> <strong>Cooking Time:</strong> ${recipe.cookingTime || "?"} mins</p>
      <p> <strong>Ingredients:</strong> <br>${recipe.ingredients?.join("<br>") || "None"}</p>
      <p> <strong>Instructions:</strong> <br>${recipe.instructions?.map((s, i) => `Step ${i + 1}: ${s}`).join("<br>") || "None"}</p>
      <hr>
  `   ;

      return recipeDiv;
}


</script>



</body>
</html>